name: Build & Release ShadowJar

on:
  push:
    branches:
      - master

permissions:
  contents: write  # Needed for creating releases

jobs:
  build-and-release:
    runs-on: ubuntu-latest

    steps:
      # 1. Checkout the repository
      - name: Checkout source
        uses: actions/checkout@v4

      # 2. Set up JDK for Gradle
      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      # 4. Build using ShadowJar
      - name: Build shadow JAR
        run: ./gradlew shadowJar

      # 5. Find built JAR
      - name: Find built JAR
        id: findjar
        run: |
          JAR_FILE=$(find build/libs -name '*-all.jar' | head -n 1)
          echo "jar_path=$JAR_FILE" >> $GITHUB_OUTPUT

      # 6. Bundle JAR + books.json into a ZIP
      - name: Create ZIP bundle
        run: |
          mkdir bundle
          cp "${{ steps.findjar.outputs.jar_path }}" bundle/
          cp books.json bundle/
          cd bundle
          zip -5 -r release.zip .  # Deflate compression
          mv result.zip ../result.zip

      # 7. Create GitHub release and upload ZIP
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: result.zip
        env:
          GITHUB_TOKEN: ${{ secrets.RELEASE_TOKEN }}
